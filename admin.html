<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanCity Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="icon" href="logo.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    #dashboard-container {
      display: none;
    }

    :root {
      --bg-body: #f8f9fa;
      --glass-bg: #ffffff;
      --glass-bg: #ffffff;
      --glass-border: rgba(0, 0, 0, 0.1);
      --primary: #4facfe;
      --secondary: #00f2fe;
      --text-main: #333333;
      --text-light: #666666;
      --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
      --success: #d4edda;
      --warning: #fff3cd;
      --danger: #f8d7da;
      --text-danger: #dc3545;
      --text-warning: #b08d00;
      --text-success: #198754;
    }

    .sidebar-close-btn {
      display: none;
    }

    [data-theme="dark"] {
      --bg-body: #1a1a2e;
      --text-main: #e2e2e2;
      --text-light: #a0a0a0;
      --glass-bg: #16213e;
      --glass-border: rgba(255, 255, 255, 0.05);
      --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .leaflet-layer {
      filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
    }

    [data-theme="dark"] .sidebar {
      background: #1e293b;
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    [data-theme="dark"] .nav-item {
      color: #94a3b8;
    }

    [data-theme="dark"] .nav-item.active,
    [data-theme="dark"] .nav-item:hover {
      background: rgba(79, 172, 254, 0.15);
      color: #4facfe;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Roboto", sans-serif;
    }

    body {
      background-color: var(--bg-body);
      min-height: 100vh;
      color: var(--text-main);
      overflow-x: hidden;
      font-family: "Roboto", sans-serif;
    }

    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
      border: none;
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
      transition:
        transform 0.2s,
        box-shadow 0.2s;
    }

    .glass:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 45px -10px rgba(0, 0, 0, 0.12);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-family: "Poppins", sans-serif;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
    }

    .btn-danger {
      background: #ff4d4d;
      color: white;
      box-shadow: 0 4px 12px rgba(255, 77, 77, 0.3);
    }

    .btn-success {
      background: #2ecc71;
      color: white;
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      background: var(--glass-bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 15px;
    }

    #auth-service {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      background: var(--bg-gradient);
    }

    .login-card {
      width: 90%;
      max-width: 400px;
      padding: 40px;
      text-align: center;
    }

    .auth-input {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
      font-family: "Inter", sans-serif;
      outline: none;
      transition: all 0.2s;
    }

    [data-theme="dark"] .auth-input {
      background: rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .auth-input:focus {
      border-color: var(--primary);
      background: transparent;
    }

    #dashboard-container {
      display: none;
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      padding: 20px;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.4);
      border-right: 1px solid var(--glass-border);
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-item {
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 12px;
      cursor: pointer;
      color: var(--text-light);
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-item.active,
    .nav-item:hover {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .main-content {
      padding: 30px;
      overflow-y: auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      margin: 10px 0;
      color: var(--text-main);
    }

    .stat-label {
      color: var(--text-light);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-icon {
      position: absolute;
      right: -10px;
      bottom: -10px;
      font-size: 5rem;
      opacity: 0.1;
      color: var(--primary);
    }

    .map-section {
      height: 400px;
      width: 100%;
      margin-bottom: 30px;
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: #e2e8f0;
    }

    [data-theme="dark"] .map-section {
      background: #0f172a;
    }

    [data-theme="dark"] .leaflet-layer {
      filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
    }

    #admin-map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    .complaints-section {
      padding: 20px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .complaint-card {
      display: flex;
      align-items: center;
      padding: 15px;
      margin-bottom: 15px;
      transition: transform 0.2s;
      border-left: 5px solid transparent;
    }

    .complaint-card:hover {
      transform: scale(1.01);
    }

    .info-col {
      flex: 1;
      padding: 0 15px;
    }

    .img-col {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
    }

    .img-col img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .action-col {
      display: flex;
      gap: 10px;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: #ffeeba;
      color: #856404;
      border-left-color: #ffeeba;
    }

    .status-pending {
      background: #fff3cd !important;
      color: #856404 !important;
      border-left: 5px solid #ffecb5 !important;
    }

    .status-progress {
      background: #cce5ff !important;
      color: #004085 !important;
      border-left: 5px solid #b8daff !important;
    }

    .status-resolved {
      background: #d4edda !important;
      color: #155724 !important;
      border-left: 5px solid #c3e6cb !important;
    }

    .status-rejected {
      background: #f8d7da !important;
      color: #721c24 !important;
      border-left: 5px solid #f5c6cb !important;
    }

    .filter-group select {
      padding: 8px 15px;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      background: rgba(255, 255, 255, 0.5);
      outline: none;
      margin-left: 10px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal {
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      padding: 30px;
    }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--text-light);
    }

    .detail-img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      #dashboard-container {
        grid-template-columns: 1fr;
      }

      .sidebar {
        display: flex;
        position: fixed;
        left: -280px;
        top: 0;
        height: 100vh;
        width: 250px;
        z-index: 10000;
        transition: left 0.3s ease;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        background: var(--glass-bg) !important;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      .sidebar.active {
        left: 0;
      }

      .sidebar-close-btn {
        display: block;
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-light);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
      }

      .sidebar-overlay.active {
        display: block;
      }

      .hamburger-btn {
        display: flex !important;
      }

      .user-card {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 15px !important;
      }

      .user-card>div {
        width: 100%;
        justify-content: space-between;
      }

      .header-title-mobile {
        display: block !important;
        margin-bottom: 10px;
        padding-left: 5px;
        color: var(--text-main);
      }

      .header-title-desktop {
        display: none;
      }

      .header {
        padding: 10px 15px !important;
      }

      .img-col {
        width: 60px;
        height: 60px;
      }

      .map-section {
        height: 300px;
      }

      .theme-toggle {
        margin-right: 10px !important;
        width: 35px;
        height: 35px;
      }
    }

    .header-title-mobile {
      display: none;
    }

    .hamburger-btn {
      display: none;
      width: 40px;
      height: 40px;
      background: var(--glass-bg);
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--primary);
      cursor: pointer;
      margin-right: 15px;
      box-shadow: var(--shadow);
    }

    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .search-input {
      width: 100%;
      padding: 12px 20px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: #e2e8f0;
      outline: none;
      font-size: 1rem;
      color: var(--text-main);
      transition: all 0.3s;
    }

    .search-input:focus {
      background: #ffffff;
      box-shadow: 0 0 0 2px var(--primary);
    }

    [data-theme="dark"] .search-input {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.2);
      color: white;
    }

    [data-theme="dark"] .search-input:focus {
      background: rgba(255, 255, 255, 0.25);
    }

    .toast {
      min-width: 300px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border-left: 5px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 15px;
      animation: slideIn 0.3s ease-out forwards;
      color: var(--text-main);
      font-weight: 500;
    }

    .toast.success {
      border-left-color: var(--text-success);
    }

    .toast.error {
      border-left-color: var(--text-danger);
    }

    .toast.info {
      border-left-color: var(--primary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <script>
    (function () {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    })();
  </script>
</head>

<body>
  <div id="toast-container"></div>
  <div id="auth-service" style="display: none">
    <div class="theme-toggle" id="auth-toggle" style="position: absolute; top: 20px; right: 20px">
      <i class="fa-solid fa-moon"></i>
    </div>
    <div class="glass login-card">
      <h2 style="margin-bottom: 10px; color: var(--primary)">
        Welcome Back Admin
      </h2>
      <p style="color: var(--text-light); margin-bottom: 30px">
        Sign in to manage city operations.
      </p>
      <form onsubmit="
            event.preventDefault();
            handleLogin();
          " class="login-form">
        <input type="text" id="admin-id" placeholder="Admin ID" class="auth-input" required />
        <input type="password" id="admin-pass" placeholder="Password" class="auth-input" required />
        <button class="btn" style="width: 100%; justify-content: center; margin-top: 20px">
          Sign In <i class="fa-solid fa-arrow-right"></i>
        </button>
      </form>
    </div>
  </div>
  <div id="dashboard-container" style="display: none">
    <aside class="sidebar glass">
      <div class="logo" style="display: flex; align-items: center; gap: 10px">
        <img src="logo.png" alt="Logo" style="width: 35px; height: 35px" />
        CleanCity
      </div>
      <div class="sidebar-close-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-arrow-left"></i>
      </div>
      <nav>
        <div class="nav-item active" onclick="switchTab('dashboard')">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('map')">
          <i class="fa-solid fa-map-location-dot"></i> Heatmap
        </div>
        <div class="nav-item" onclick="switchTab('users')">
          <i class="fa-solid fa-users"></i> Users & Points
        </div>
        <div class="nav-item" style="margin-top: auto; color: var(--text-danger)" id="admin-logout-btn">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </div>
      </nav>
    </aside>
    <main class="main-content">
      <div id="dashboard-content-area">
        <h3 class="header-title-mobile">Dashboard</h3>
        <div class="header glass" style="
              padding: 15px 25px;
              border-radius: 12px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
          <div style="display: flex; align-items: center">
            <div class="hamburger-btn" onclick="toggleSidebar()">
              <i class="fa-solid fa-bars"></i>
            </div>
            <h3 class="header-title-desktop" style="margin: 0; margin-left: 10px">
              Dashboard
            </h3>
          </div>
          <div style="display: flex; align-items: center">
            <div class="theme-toggle" id="admin-toggle" style="margin-right: 20px">
              <i class="fa-solid fa-moon"></i>
            </div>
            <div class="user-profile" style="display: flex; align-items: center; gap: 10px">
              <span class="admin-text">Admin</span>
              <div style="
                    width: 35px;
                    height: 35px;
                    background: var(--primary);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                  ">
                <i class="fa-solid fa-user-shield"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="stats-grid">
          <div class="glass stat-card">
            <div class="stat-value" id="total-reports">0</div>
            <div class="stat-label">Total Reports</div>
            <i class="fa-solid fa-clipboard-list stat-icon"></i>
          </div>
          <div class="glass stat-card">
            <div class="stat-value" id="pending-reports">0</div>
            <div class="stat-label">Pending</div>
            <i class="fa-solid fa-clock stat-icon"></i>
          </div>
          <div class="glass stat-card">
            <div class="stat-value" id="resolved-reports">0</div>
            <div class="stat-label">Resolved</div>
            <i class="fa-solid fa-check-circle stat-icon"></i>
          </div>
        </div>
        <div id="map-view" class="glass map-section">
          <div id="admin-map"></div>
        </div>
        <div class="glass complaints-section">
          <div class="table-header">
            <h4>Incoming Reports</h4>
            <div class="filter-group">
              <select id="status-filter" onchange="filterComplaints()">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="progress">In Progress</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>
          </div>
          <div id="complaints-list">
            <div style="
                  text-align: center;
                  padding: 20px;
                  color: var(--text-light);
                ">
              Loading complaints...
            </div>
          </div>
        </div>
      </div>
      <div id="users-view" style="display: none">
        <div class="glass" style="padding: 20px">
          <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              ">
            <div style="display: flex; align-items: center; gap: 10px">
              <button class="btn btn-outline" style="
                    width: 35px;
                    height: 35px;
                    padding: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                  " onclick="switchTab('dashboard')">
                <i class="fa-solid fa-arrow-left"></i>
              </button>
              <h4><i class="fa-solid fa-users"></i> Registered Citizens</h4>
            </div>
            <button type="button" class="btn" style="
                  padding: 5px 15px;
                  font-size: 0.8rem;
                  background: var(--danger);
                  color: #721c24;
                  border: 1px solid #f5c6cb;
                " onclick="clearAllUsers()">
              <i class="fa-solid fa-trash"></i> Reset Users
            </button>
          </div>
          <div style="margin-bottom: 15px">
            <input type="text" id="user-search" class="search-input" placeholder="Search user by email..."
              onkeyup="renderUserList()" />
          </div>
          <div id="admin-users-list" style="display: flex; flex-direction: column; gap: 10px">
            <div style="text-align: center; padding: 20px; opacity: 0.6">
              Loading users...
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div class="modal-overlay" id="detail-modal">
    <div class="glass modal">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3 id="modal-type" style="margin-bottom: 10px">Garbage Type</h3>
      <img id="modal-img" src="" class="detail-img" alt="Evidence" />
      <div style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
          ">
        <div>
          <small>Pincode</small>
          <p id="modal-loc">Lat, Lng</p>
        </div>
        <div>
          <small>Reported By</small>
          <p id="modal-user">User ID</p>
        </div>
        <div>
          <small>Time</small>
          <p id="modal-time">Timestamp</p>
        </div>
        <div>
          <small>Status</small>
          <p id="modal-status" style="font-weight: bold">PENDING</p>
        </div>
      </div>

      <div id="cleanup-evidence-section" style="margin-bottom: 20px;">
        <h5 style="margin-bottom: 10px; color: var(--text-light);">Cleanup Evidence (Optional)</h5>
        <input type="file" id="cleanup-upload" accept="image/*" class="auth-input" style="padding: 10px;">
        <div id="cleanup-preview-container"
          style="display: none; margin-top: 10px; position: relative; width: fit-content;">
          <img id="cleanup-preview" src=""
            style="width: 100%; max-width: 300px; height: 200px; object-fit: cover; border-radius: 8px;">
          <button type="button" onclick="removeEvidence()" class="btn"
            style="position: absolute; top: 10px; right: 10px; width: 35px; height: 35px; background: #ff4d4d; color: white; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); padding: 0;">
            <i class="fa-solid fa-trash" style="font-size: 1rem;"></i>
          </button>
        </div>
      </div>

      <hr style="
            border: 0;
            border-top: 1px solid var(--glass-border);
            margin: 20px 0;
          " />
      <div style="display: flex; gap: 10px; flex-wrap: wrap">
        <button class="btn btn-outline" onclick="updateStatus('pending')">
          Mark Pending
        </button>
        <button class="btn btn-outline" onclick="updateStatus('progress')">
          In Progress
        </button>
        <button class="btn btn-success" onclick="updateStatus('resolved')">
          Resolve & Reward
        </button>
        <button class="btn btn-danger" onclick="updateStatus('rejected')">
          Reject (Spam)
        </button>
        <button class="btn btn-danger" onclick="deleteComplaint()" style="margin-left: auto">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    </div>


  </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import * as firebaseDb from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyC4OeHd1iqPFSS2OtyWNy6DXgGhNmMbk54",
      authDomain: "web-app-8edcb.firebaseapp.com",
      databaseURL: "https://web-app-8edcb-default-rtdb.firebaseio.com",
      projectId: "web-app-8edcb",
      storageBucket: "web-app-8edcb.firebasestorage.app",
      messagingSenderId: "23560015388",
      appId: "1:23560015388:web:39bc4d9ca858975f62d9d9",
    };
    const IMGBB_API_KEY = "eef75a5e0bc4f6786b78d13a0bdeabf9";
    let app, db;
    try {
      app = initializeApp(firebaseConfig);
      db = firebaseDb.getDatabase(app);
      console.log("Firebase initialized");
    } catch (e) {
      console.error("Firebase Init Error: ", e);
      alert("Please edit the HTML file to add your Firebase Config!");
    }
    let currentComplaints = {};
    let selectedComplaintId = null;
    let map = null;
    let markers = [];
    if (localStorage.getItem("adminLoggedIn") === "true") {
      document.getElementById("auth-service").style.display = "none";
      document.getElementById("dashboard-container").style.display = "grid";
      setTimeout(() => {
        initMap();
        listenToComplaints();
      }, 500);
    }
    window.handleLogin = async () => {
      const id = document.getElementById("admin-id").value;
      const pass = document.getElementById("admin-pass").value;
      const btn = document.querySelector(".login-form .btn");
      const originalText = btn.innerHTML;
      if (!id || !pass) {
        alert("Please enter credentials");
        return;
      }
      btn.innerHTML =
        '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
      btn.disabled = true;
      setTimeout(() => {
        if (id === "admin" && pass === "admin123") {
          localStorage.setItem("adminAuth", "true");
          checkAdminAuth();
        } else {
          alert("Invalid Credentials");
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }, 800);
    };
    window.checkAdminAuth = () => {
      const isAuth = localStorage.getItem("adminAuth");
      if (isAuth === "true") {
        document.getElementById("auth-service").style.display = "none";
        document.getElementById("dashboard-container").style.display = "grid";
        initMap();
        listenToComplaints();
      } else {
        document.getElementById("auth-service").style.display = "flex";
        document.getElementById("dashboard-container").style.display = "none";
      }
    };
    const dashToggle = document.getElementById("admin-toggle");
    const authToggle = document.getElementById("auth-toggle");
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("theme") || "light";
    root.setAttribute("data-theme", savedTheme);
    updateIcons(savedTheme);
    function bindToggle(btn) {
      if (!btn) return;
      btn.addEventListener("click", () => {
        const currentTheme = root.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        root.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateIcons(newTheme);
      });
    }
    bindToggle(dashToggle);
    bindToggle(authToggle);
    function updateIcons(theme) {
      const iconHtml =
        theme === "dark"
          ? '<i class="fa-solid fa-sun"></i>'
          : '<i class="fa-solid fa-moon"></i>';
      if (dashToggle) dashToggle.innerHTML = iconHtml;
      if (authToggle) authToggle.innerHTML = iconHtml;
    }
    window.logout = () => {

      localStorage.removeItem("adminAuth");
      localStorage.removeItem("adminLoggedIn");
      location.reload();
    };
    function initMap() {
      if (map) return;
      map = L.map("admin-map", { scrollWheelZoom: false }).setView(
        [20.5937, 78.9629],
        5,
      );
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(map);
    }
    function listenToComplaints() {
      const complaintsRef = firebaseDb.ref(db, "complaints");
      firebaseDb.onValue(complaintsRef, (snapshot) => {
        const data = snapshot.val();
        currentComplaints = data || {};
        renderDashboard();
        updateStats();
        updateMap();
      });
    }
    function renderDashboard() {
      const container = document.getElementById("complaints-list");
      container.innerHTML = "";
      const filter = document.getElementById("status-filter").value;
      const list = Object.entries(currentComplaints).reverse();
      if (list.length === 0) {
        container.innerHTML =
          '<div style="text-align: center; padding: 20px;">No complaints found.</div>';
        return;
      }
      list.forEach(([key, val], index) => {
        if (filter !== "all" && val.status !== filter) return;
        const statusClass = `status-${val.status || "pending"}`;
        const card = document.createElement("div");
        card.className = `glass complaint-card ${statusClass}`;
        card.style.borderLeft = `5px solid var(--${getThemeColor(val.status)})`;
        card.style.opacity = "0";
        card.style.animation = `slideUpFade 0.4s ease-out forwards ${index * 0.05}s`;
        card.innerHTML = `
                    <div class="img-col">
                        <img src="${val.image_url || "https://via.placeholder.com/150"}" alt="Waste">
                    </div>
                    <div class="info-col">
                        <div style="display: flex; justify-content: space-between;">
                            <h5 style="margin-bottom: 5px;">${val.type || "Unknown Waste"}</h5>
                            <span class="status-badge ${statusClass}">${val.status === 'rejected' ? 'REJECTED (SPAM)' : (val.status || "Pending")}</span>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-light);">
                            <i class="fa-solid fa-location-dot"></i> ${formatLoc(val.lat, val.lng)} 
                            ${val.pincode ? `<br><small style="margin-left:5px; color:#888;">${val.pincode}</small>` : ''} • 
                            ${new Date(val.timestamp).toLocaleDateString()}
                        </p>
                    </div>
                    <div class="action-col">
                        <a href="https://www.google.com/maps/search/?api=1&query=${val.lat},${val.lng}" target="_blank" class="btn btn-outline" style="padding: 8px 12px; border-color:#ccc; color:#666;" title="View on Map">
                            <i class="fa-solid fa-map"></i>
                        </a>
                        <button class="btn btn-outline" style="padding: 8px 12px;" onclick="openModal('${key}')">
                            Review
                        </button>
                    </div>
                `;
        container.appendChild(card);
      });
    }
    function updateStats() {
      const list = Object.values(currentComplaints);
      document.getElementById("total-reports").innerText = list.length;
      document.getElementById("pending-reports").innerText = list.filter(
        (i) => i.status === "pending" || !i.status,
      ).length;
      document.getElementById("resolved-reports").innerText = list.filter(
        (i) => i.status === "resolved",
      ).length;
    }
    function updateMap() {
      if (!map) return;
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
      Object.entries(currentComplaints).forEach(([key, val]) => {
        if (val.lat && val.lng) {
          const color = getThemeColor(val.status);
          const marker = L.circleMarker([val.lat, val.lng], {
            radius: 8,
            fillColor: `var(--${color})`,
            color: "#fff",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
          }).addTo(map);
          marker.setStyle({ fillColor: getColorHex(val.status) });
          marker.bindPopup(`<b>${val.type}</b><br>Status: ${val.status}`);
          markers.push(marker);
        }
      });
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1), { maxZoom: 8 });
      }
    }
    window.openModal = (id) => {
      selectedComplaintId = id;
      const data = currentComplaints[id];
      document.getElementById("modal-type").innerText = data.type;
      document.getElementById("modal-img").src = data.image_url;
      document.getElementById("modal-loc").innerText = data.pincode || `${data.lat}, ${data.lng}`;
      document.getElementById("modal-user").innerText = data.userId || "Anon";
      document.getElementById("modal-time").innerText = new Date(
        data.timestamp,
      ).toLocaleString();
      document.getElementById("modal-status").innerText = (
        data.status === 'rejected' ? 'REJECTED (SPAM)' : (data.status || "PENDING")
      ).toUpperCase();


      document.getElementById('cleanup-upload').value = "";
      document.getElementById('cleanup-preview-container').style.display = 'none';


      if (data.status === 'resolved' && data.cleanup_image_url) {
        document.getElementById('cleanup-preview-container').style.display = 'block';
        document.getElementById('cleanup-preview').src = data.cleanup_image_url;
        document.getElementById('cleanup-upload').style.display = 'none';
      } else {
        document.getElementById('cleanup-upload').style.display = 'block';
      }

      document.getElementById("detail-modal").style.display = "flex";
    };


    document.getElementById('cleanup-upload').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('cleanup-preview').src = e.target.result;
          document.getElementById('cleanup-preview-container').style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    };

    window.removeEvidence = () => {
      document.getElementById('cleanup-upload').value = "";
      document.getElementById('cleanup-preview-container').style.display = 'none';
      document.getElementById('cleanup-preview').src = "";
    };

    window.closeModal = () => {
      document.getElementById("detail-modal").style.display = "none";
    };

    window.updateStatus = async (newStatus) => {
      if (!selectedComplaintId) return;
      const key = selectedComplaintId;
      const complaint = currentComplaints[key];
      const updates = {};
      updates[`/complaints/${key}/status`] = newStatus;


      if (newStatus === "resolved") {
        const fileInput = document.getElementById('cleanup-upload');
        if (fileInput.files.length > 0) {
          const btn = document.querySelector('.btn-success');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading Evidence...';
          btn.disabled = true;

          try {
            const formData = new FormData();
            formData.append("image", fileInput.files[0]);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
              method: "POST",
              body: formData
            });
            const data = await res.json();
            if (data.success) {
              updates[`/complaints/${key}/cleanup_image_url`] = data.data.url;
            } else {
              alert("Evidence Upload Failed: " + (data.error ? data.error.message : "Unknown error"));
              btn.innerHTML = originalText;
              btn.disabled = false;
              return;
            }
          } catch (e) {
            alert("Upload Error: " + e.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
          }
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }

      if (newStatus === "resolved") {
        const userEmail = complaint.userId;
        console.log("Rewarding User:", userEmail);
        if (userEmail && userEmail.includes("@")) {
          const uid = userEmail.replace(/\./g, "_");
          const userRef = firebaseDb.ref(db, `users/${uid}`);
          firebaseDb.get(userRef)
            .then((snap) => {
              const data = snap.val() || {};
              const newPoints = (data.points || 0) + 10;
              const newReports = (data.reports || 0) + 1;
              firebaseDb.update(userRef, { points: newPoints, reports: newReports })
                .then(() =>
                  alert(`SUCCESS: Added 10 Points to ${userEmail}!`),
                )
                .catch((e) => alert("ERROR Writing Points: " + e.message));
            })
            .catch((e) => alert("ERROR Reading User: " + e.message));
        } else {
          alert(
            `WARNING: User ID '${userEmail}' is not a valid email. Cannot reward.`,
          );
        }
      }
      firebaseDb.update(firebaseDb.ref(db), updates)
        .then(() => {
          closeModal();
        })
        .catch((err) => alert("Error updating status: " + err.message));
    };
    window.deleteComplaint = () => {
      showConfirm("Are you sure you want to delete this report?", () => {
        if (!selectedComplaintId) return;
        firebaseDb.remove(firebaseDb.ref(db, "complaints/" + selectedComplaintId))
          .then(() => closeModal())
          .catch((err) => alert(err.message));
      });
    };
    window.filterComplaints = () => {
      renderDashboard();
    };
    function formatLoc(lat, lng) {
      return `${parseFloat(lat).toFixed(4)}, ${parseFloat(lng).toFixed(4)}`;
    }
    function getThemeColor(status) {
      if (status === "resolved") return "success";
      if (status === "progress") return "primary";
      if (status === "rejected") return "danger";
      return "warning";
    }
    function getColorHex(status) {
      if (status === "resolved") return "#4cc9f0";
      if (status === "progress") return "#4361ee";
      if (status === "rejected") return "#ff4d4d";
      return "#f8961e";
      return "#f8961e";
    }
    window.switchTab = (tab) => {
      document.getElementById("dashboard-content-area").style.display =
        "none";
      document.getElementById("users-view").style.display = "none";
      document
        .querySelectorAll(".nav-item")
        .forEach((el) => el.classList.remove("active"));
      document.querySelectorAll(".nav-item").forEach((el) => {
        const onclickAttr = el.getAttribute("onclick");
        if (onclickAttr && onclickAttr.includes(tab)) {
          el.classList.add("active");
        }
      });
      if (window.innerWidth <= 768) {
        document.querySelector(".sidebar").classList.remove("active");
        const overlay = document.querySelector(".sidebar-overlay");
        if (overlay) overlay.classList.remove("active");
      }
      if (tab === "dashboard") {
        document.getElementById("dashboard-content-area").style.display =
          "block";
      } else if (tab === "map") {
        document.getElementById("dashboard-content-area").style.display =
          "block";
        document
          .getElementById("admin-map")
          .scrollIntoView({ behavior: "smooth" });
      } else if (tab === "users") {
        document.getElementById("users-view").style.display = "block";
        loadAdminUserList();
      }
    };
    checkAdminAuth();
    window.showToast = (message, type = "info") => {

      if (type === 'error' && (message.includes('ReferenceError') || message.includes('firebase') || message.includes('defined'))) {
        console.warn("Toast Suppressed:", message);
        return;
      }
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      let icon = "fa-info-circle";
      if (type === "success") icon = "fa-check-circle";
      if (type === "error") icon = "fa-exclamation-circle";
      toast.innerHTML = `
                <i class="fa-solid ${icon}" style="font-size: 1.2rem; color: var(--text-${type === "info" ? "main" : type})"></i>
                <span>${message}</span>
            `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = "slideOut 0.3s ease-in forwards";
        toast.addEventListener("animationend", () => {
          toast.remove();
        });
      }, 3000);
    };
    window.toggleSidebar = () => {
      document.querySelector(".sidebar").classList.toggle("active");
      let overlay = document.querySelector(".sidebar-overlay");
      if (!overlay) {
        overlay = document.createElement("div");
        overlay.className = "sidebar-overlay";
        overlay.onclick = toggleSidebar;
        document.body.appendChild(overlay);
      }
      overlay.classList.toggle("active");
    };
    let adminUsersData = {};
    function loadAdminUserList() {
      const list = document.getElementById("admin-users-list");
      firebaseDb.onValue(firebaseDb.ref(db, "users"), (snapshot) => {
        adminUsersData = snapshot.val() || {};
        renderUserList();
      });
    }
    window.renderUserList = () => {
      const list = document.getElementById("admin-users-list");
      const searchTerm = document.getElementById("user-search")
        ? document.getElementById("user-search").value.toLowerCase()
        : "";
      if (Object.keys(adminUsersData).length === 0) {
        list.innerHTML =
          '<div style="text-align: center;">No users registered yet.</div>';
        return;
      }
      let html = "";
      const sorted = Object.entries(adminUsersData).sort(
        ([, a], [, b]) => (b.points || 0) - (a.points || 0),
      );
      let count = 0;
      sorted.forEach(([uid, u], index) => {
        if (
          searchTerm &&
          u.email &&
          !u.email.toLowerCase().includes(searchTerm)
        )
          return;
        count++;
        const userEmail = u.email;
        const reportCount = Object.values(currentComplaints).filter(
          (c) => c.userId === userEmail,
        ).length;
        const animStyle = `animation: slideUpFade 0.4s ease-out forwards ${count * 0.05}s; opacity: 0;`;
        html += `
                    <div class="glass user-card" style="${animStyle} display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 12px; border: 1px solid var(--glass-border);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="min-width: 45px; width: 45px; height: 45px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                ${u.email ? u.email.charAt(0).toUpperCase() : "U"}
                            </div>
                            <div style="flex: 1;">
                                <h5 style="margin: 0; font-size: 1rem; word-break: break-all;">${u.email || "Unknown User"}</h5>
                                <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 4px;">
                                    <span style="opacity: 0.8;">Pass: ****</span>
                                    <span style="margin-left: 10px; opacity: 0.8;"><i class="fa-solid fa-file-contract"></i> ${reportCount} Reports</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.05); padding: 5px 15px; border-radius: 30px;">
                                <button class="btn" style="width: 30px; height: 30px; padding: 0; background: var(--warning); color: #856404; border: 1px solid #ffeeba; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: none;" onclick="adjustPoints('${uid}', -10)" title="-10 Points">
                                    <i class="fa-solid fa-minus" style="font-size: 0.9rem; font-weight: bold;"></i>
                                </button>
                                <div style="text-align: center; min-width: 50px;">
                                    <span style="font-size: 1.2rem; font-weight: 800; color: var(--primary); display: block; line-height: 1;">${u.points || 0}</span>
                                    <small style="font-size: 0.6rem; text-transform: uppercase; opacity: 0.7;">Points</small>
                                </div>
                                <button class="btn" style="width: 30px; height: 30px; padding: 0; background: var(--success); color: #155724; border: 1px solid #c3e6cb; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: none;" onclick="adjustPoints('${uid}', 10)" title="+10 Points">
                                    <i class="fa-solid fa-plus" style="font-size: 0.9rem; font-weight: bold;"></i>
                                </button>
                            </div>
                            <button type="button" class="btn" style="width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--danger); color: #721c24; border: 1px solid #f5c6cb;" onclick="deleteUser('${uid}')" title="Delete User">
                                <i class="fa-solid fa-trash" style="font-size: 0.9rem;"></i>
                            </button>
                        </div>
                    </div>
                `;
      });
      if (count === 0) {
        html =
          '<div style="text-align: center; padding: 20px;">No matching users found.</div>';
      }
      list.innerHTML = html;
    };
    window.adjustPoints = (uid, amount) => {
      const userRef = firebaseDb.ref(db, "users/" + uid);
      firebaseDb.get(userRef).then((snap) => {
        const data = snap.val() || {};
        const currentPoints = parseInt(data.points || 0);
        const newPoints = currentPoints + amount;
        firebaseDb.update(firebaseDb.ref(db, "users/" + uid), { points: newPoints })
          .then(() => {
            showToast(`Points Updated: ${newPoints}`, "success");
          })
          .catch((e) => showToast("Error: " + e.message, "error"));
      });
    };

    window.showConfirm = (msg, callback) => {
      document.getElementById('confirm-msg').innerText = msg;
      const yesBtn = document.getElementById('confirm-yes-btn');
      // Remove any previous listener to be safe (though assignment overwrites it)
      yesBtn.onclick = () => {
        callback();
        closeConfirmModal();
      };
      document.getElementById('confirm-modal').style.display = 'flex';
    }

    window.closeConfirmModal = () => {
      document.getElementById('confirm-modal').style.display = 'none';
      // Clear the handler to prevent accidental double-clicks or phantom firings
      document.getElementById('confirm-yes-btn').onclick = null;
    }

    window.deleteUser = (uid) => {
      showConfirm("Are you sure you want to delete this user? This cannot be undone.", () => {
        firebaseDb.remove(firebaseDb.ref(db, "users/" + uid))
          .then(() => {
            showToast("User deleted successfully", "success");
          })
          .catch((err) => showToast("Error: " + err.message, "error"));
      });
    };
    window.clearAllUsers = () => {
      showConfirm("⚠️ DANGER: This will delete ALL registered users and their points. Are you sure?", () => {
        firebaseDb.remove(firebaseDb.ref(db, "users"))
          .then(() => {
            alert("All users have been deleted.");
          })
          .catch((err) => alert("Error: " + err.message));
      });
    };


    window.logout = () => {
      showConfirm("Are you sure you want to logout?", () => {
        localStorage.removeItem("adminAuth");
        localStorage.removeItem("adminLoggedIn");
        location.reload();
      });
    }
  </script>

  <div id="confirm-modal" class="modal-overlay" style="z-index: 20000; align-items: center; justify-content: center;">
    <div class="glass modal" style="max-width: 400px; text-align: center;">
      <i class="fa-solid fa-triangle-exclamation"
        style="font-size: 3rem; color: var(--warning); margin-bottom: 20px;"></i>
      <h3 style="margin-bottom: 15px;">Confirm Action</h3>
      <p id="confirm-msg" style="margin-bottom: 25px; color: var(--text-light);">Are you sure?</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-outline" style="min-width: 100px;" onclick="closeConfirmModal()">Cancel</button>
        <button class="btn btn-danger" id="confirm-yes-btn" style="min-width: 100px;">Yes, Proceed</button>
      </div>
    </div>
  </div>
</body>

</html>